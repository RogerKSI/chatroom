<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>
		<title>Chat Example</title>

		<!--Import Google Icon Font-->
		<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<!--Import materialize.css-->
		<link type="text/css" rel="stylesheet" href="/resources/css/materialize.min.css"  media="screen,projection"/>
		<link type="text/css" rel="stylesheet" href="/resources/css/style.css" />

		<!--Let browser know website is optimized for mobile-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	</head>

	<body>
		<!--Import jQuery before materialize.js-->
		
		<div class="container" style="padding-top:30px;">
			<div id="log" style="height: 60vh;max-height: 60vh;overflow-y:auto;padding:30px 30px 30px 30px;">
			</div>
			<div style="padding-top: 30px;">
				<form id="form">
					message: <input type="text" id="msg" size="64"/>
				 <button class="btn waves-effect waves-light" type="submit" name="action">Submit
						<i class="material-icons right">send</i>
					</button>
				</form>		
			</div>
		</div>
		
		
		<script type="text/javascript" src="
		https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="/resources/js/materialize.min.js"></script>
		<script type="text/javascript">
			window.onload = function () {
					var i = 0;
					var port = [8080,8081];
					var conn;
					var msg = document.getElementById("msg");
					var log = document.getElementById("log");
					var status = 0;

					function appendLog(item) {

							var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
							log.appendChild(item);
							if (doScroll) {
									log.scrollTop = log.scrollHeight - log.clientHeight;
							}
					}

					document.getElementById("form").onsubmit = function () {
							if (!conn) {
									return false;
							}
							if (!msg.value) {
									return false;
							}
							conn.send(msg.value);
							msg.value = "";
							return false;
					};

					if (window["WebSocket"]) {
						connect(i);
					} else {
							var item = document.createElement("div");
							item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
							appendLog(item);
					}
					
					function connect(i){
							//conn = new WebSocket("ws://" + document.location.host + "/ws/111");
							group = document.location.href.split('/');
							console.log(document.location);
							console.log(port);
							console.log(i);
							conn = new WebSocket("ws://" + document.location.hostname + ":" + port[i] + "/ws/" + group[group.length-1]);
							conn.onclose = function (evt) {
									if(status==1){
										var item = document.createElement("div");
										item.innerHTML = "<b>Connection closed.</b>";
										appendLog(item);
										status=0;
									}
									
									i++;
									if(i >= port.length)
										i=0;
									connect(i);
							};
							conn.onopen = function (evt) {
									var item = document.createElement("div");
									item.innerHTML = "<b>can connect</b>";
									appendLog(item);
									status=1;
							};
							conn.onmessage = function (evt) {
									var messages = evt.data.split('\n');
									for (var i = 0; i < messages.length; i++) {
										var message = messages[i].split(":");
										var cookie = document.cookie.split('=');

										var item = $("<div class='row'></div>");
										var div_message;
										if(message[0]==cookie[1]) {
											div_message = $("<div class='message right'></div>");
										} else {
											div_message = $("<div class='message'></div>");
										}
										
										div_message.html(messages[i]);
										item.append(div_message);
										appendLog(item[0]);
									}
							};
						
					}
			};
		</script>
	</body>
</html>